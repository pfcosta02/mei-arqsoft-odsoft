version: "3.8"

services:

  # -------- BookGenre_C --------
  bookgenre_c:
    image: bookgenre_c:latest
    build:
      context: ./BookGenre_C
    deploy:
      replicas: 1
    environment:
      - SPRING_PROFILES_ACTIVE=bootstrap,jpa
    ports:
      - "8083:8080"  # Porta externa do servi√ßo
    networks:
      - lms_network
    volumes:
      - uploaded_files_bookgenre_c:/tmp

  # -------- BookGenre_Q --------
  bookgenre_q:
    image: bookgenre_q:latest
    build:
      context: ./BookGenre_Q
    deploy:
      replicas: 1
    environment:
      - SPRING_PROFILES_ACTIVE=bootstrap,jpa
    ports:
      - "8084:8080"
    networks:
      - lms_network
    volumes:
      - uploaded_files_bookgenre_q:/tmp

  # -------- Authors_C --------
  authors_c:
    image: authors_c:latest
    build:
      context: ./Authors_C
    deploy:
      replicas: 1
    environment:
      - SPRING_PROFILES_ACTIVE=bootstrap,jpa
    ports:
      - "8085:8080"
    networks:
      - lms_network
    volumes:
      - uploaded_files_authors_c:/tmp

  # -------- Authors_Q --------
  authors_q:
    image: authors_q:latest
    build:
      context: ./Authors_Q
    deploy:
      replicas: 1
    environment:
      - SPRING_PROFILES_ACTIVE=bootstrap,jpa
    ports:
      - "8086:8080"
    networks:
      - lms_network
    volumes:
      - uploaded_files_authors_q:/tmp

  # -------- Postgres --------
  postgres:
    image: postgres:16
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=postgres
    deploy:
      replicas: 1
    ports:
      - "5432:5432"
    networks:
      - lms_network
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql

  # -------- RabbitMQ --------
  rabbitmq:
    image: rabbitmq:3-management
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
    deploy:
      replicas: 1
    ports:
      - "5672:5672"
      - "15672:15672"
    networks:
      - lms_network

networks:
  lms_network:
    driver: overlay

volumes:
  uploaded_files_bookgenre_c:
  uploaded_files_bookgenre_q:
  uploaded_files_authors_c:
  uploaded_files_authors_q:
  postgres_data:
